.. _v1.6-release-notes:

v1.6 Release Notes
==================

Highlights in 1.6:

- `OnDemand passed a security audit!`_
- `Added rendering of HTML or Markdown in Job Composer template manifests`_
- `Added L18n hooks to the Dashboard and Job Composer`_
- `Updated ngnix_stage to always remove stale PID files`_
- `Added job array support for LSF and PBSPro adapters`_
- `Disabled warning about eager loading gems`_
- `Fix crash in nginx_stage`_
- `Active Jobs shows empty cell if account is nil`_
- `Fixed Time Used format for Active Jobs`_
- `Improved Slurm adapter`_
- `Job Composer layout changes`_
- `Improved Grid Engine adapter`_
- `Updated web-application dependencies`_

Details
-------

OnDemand passed a security audit!
.................................

At the end of 2018 `TrustedCI`_ completed a security audit of OnDemand [TrustedCI_Audit]_. Quoting their audits major findings:

  ::

    - Discovered several implementation issues (bugs) that could affect the
      proper operation of Open OnDemand. 
    - No major issues were found in a comprehensive evaluation of the
      architecture and critical resources in Open OnDemand, and analysis of
      potential code weaknesses in critical components.
    - Found a potential vulnerability, dormant based on current configuration
      and launch settings.

The potential security issue was the ability for a user to consume all available resources on a machine using a `fork bomb`_ or similar attack. OnDemand is intentionally designed to allow users to do anything that they are permitted to do on a system. The OnDemand team expects that HPC centers are already active managing user resource utilization with tools like ``ulimit`` or ``cgroups``. After a conversation about the prior two assumptions TrustedCI agreed that the ability of a user to run a fork bomb was not an issue with OnDemand.

 To address the bugs that were found three issues were opened on Github.

  - Creating a new directory whose name includes HTML/XML tags results in unintended behavior (`ood-fileexplorer#198`_)
  - Datatables does not handle long job names well (`ood-myjobs#290`_)
  - Default "simple sequential job" is reported to have not execute permissions on job script (`ood-myjobs#289`_)

.. _ood-fileexplorer#198: https://github.com/OSC/ood-fileexplorer/issues/198
.. _ood-myjobs#289: https://github.com/OSC/ood-myjobs/issues/289
.. _ood-myjobs#290: https://github.com/OSC/ood-myjobs/issues/290

The issue with the File Explorer is not a security concern has not been reported as a problem that real users have, and given that the OnDemand team intends to replace the File Explorer as part of the OnDemand 2.0 project the issue is one that will not be fixed for now. The File Explorer issue will be addressed in the next major version of that application. The other two issues-both relating to the Job Composer-have been addressed for the 1.6.x release.

.. _fork bomb: https://en.wikipedia.org/wiki/Fork_bomb
.. _TrustedCI: https://trustedci.org/

Added rendering of HTML or Markdown in Job Composer template manifests
......................................................................

If the environment variable ``RENDER_TEMPLATE_NOTES_AS_MARKDOWN`` is set to a truthy value then job template manifests displayed in the Job Composer that are written in Markdown will be run through the RedCarpet renderer. HTML values will always be rendered as HTML. This will allow sites to embed images or links to documentation in their templates. (`ood-mjobs#291`_)

.. _ood-mjobs#291: https://github.com/OSC/ood-myjobs/issues/278


Added L18n hooks to the Dashboard and Job Composer
..................................................

Localization hooks have been added to the Dashboard and the Job Composer. This work does not cover all the strings necessary to provide full internationalization but is the starting point of such a project if there is enough demand.

An initial English/OSC locale has been added. Sites wishing to override the locale should do the following:

  - Step 1
  - Step b

.. warning::

  Translations have certain variables passed to them for example ``%{support_url}``. Those variables may be used or removed from the translation, but they may not be renamed without crashing the application.

.. note::

  Localization files are YAML documents; remember that YAML is space sensitive, and tabs are not valid for indentation per the `YAML spec`_.

.. _Yaml spec: https://yaml.org/spec/1.2/spec.html#id2777534

Updated ngnix_stage to always remove stale PID files
....................................................

``nginx_stage clean`` will now remove PID and socket files for processes that are not longer running. Whenever a stale PID files is deleted the action is reported to ``stderr``. (`ondemand#11`_)

.. _ondemand#11: https://github.com/OSC/ondemand/issues/11

Added job array support for LSF and PBSPro adapters
...................................................

Job Composer and Active Jobs now support job arrays for all adapters that OnDemand supports including LSF and PBSPro.


Disabled warning about eager loading gems
.........................................

Job Composer logs will no longer contain complaints about gems not being eager loaded. (`ood-myjobs#285`_)

.. _ood-myjobs#285: https://github.com/OSC/ood-myjobs/issues/285

Fix crash in nginx_stage
........................

``nginx_stage`` will no longer crash when one of the ``pun_custom_env`` values in ``/etc/ood/config/nginx_stage.yml`` is a number and not a string. (`ondemand#26`_)

.. _ondemand#26: https://github.com/OSC/ondemand/issues/26

Active Jobs shows empty cell if account is nil
..............................................

Previously, if a job was submitted without an account Active Jobs would display that job as having an account of ``(null)``. Now the field will simply be blank.

Fixed Time Used format for Active Jobs
......................................

In 1.5 the ``Time Used`` field in Active Jobs was simply the number of seconds as an integer. In 1.6 this has been changed back to ``HH:MM:SS``.

Improved Slurm adapter
......................

``squeue`` may report the name of a job submitted without an explicit as being the content of the script. To improve the reliability of parsing ``squeue`` output the record delimiter has been changed from newlines to the `ASCII/Unicode record separator`_.

.. _ASCII/Unicode record separator: https://en.wikipedia.org/wiki/Delimiter#Conventions

Job Composer layout changes
...........................

Job names that were exceptionally long and did not contain 'break-able' punctuation could break the layout of the Job Composer's data table. The table has been updated so that job names wrap and will break mid-word if necessary.

Improved Grid Engine adapter
............................

To match the behavior of the other adapters the Grid Engine adapter will now attempt to detect whether the user has set the working directory of a job. If the user has not passed the ``-wd`` or ``-cwd`` flags in the first 1024 characters of their job script then the adapter will append ``-cwd`` to the arguments passed to ``qsub``.

Updated web-application dependencies
....................................

Dependencies for the individual web applications have been updated including Ruby gems for most applications, and switching from ``pty.js`` to the actively maintained ``node-pty`` for the Shell application.

.. [TrustedCI_Audit] Elisa Heymann, Joel Atkins, Barton P. Miller.  "TrustedCI: The NSF Cybersecurity Center of Excellence Open OnDemand Report". TrustedCI: The NSF Cybersecurity Center of Excellence. December 2018.